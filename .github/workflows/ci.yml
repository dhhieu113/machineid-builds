name: CI - MachineId Build multi-platform

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'   # triggers on v0.0.1, v1.0.0, v2.3.4 etc.
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

# Add default permissions to the workflow
permissions:
  contents: write   # Needed for creating releases
  packages: write   # Needed for publishing packages

jobs:
  build-native:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04, macos-14, windows-2022]
        build_type: [Release]
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get submodules (if any)
        run: git submodule update --init --recursive

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v1
        with:
          cmake-version: '3.26.0'

      - name: Configure (CMake)
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} ..

      - name: Build (CMake)
        run: |
          cd build
          cmake --build . --config ${{ matrix.build_type }} --parallel

      - name: Run tests (ctest) if present
        run: |
          cd build
          if [ -f CTestTestfile.cmake ] ; then
            ctest --output-on-failure -C ${{ matrix.build_type }}
          else
            echo "No tests configured (no CTestTestfile.cmake found)."
          fi
        shell: bash
        
      - name: Collect build artifacts
        run: |
          mkdir -p artifacts
          
          # Define the runtime identifier based on OS
          case "${{ matrix.os }}" in
            ubuntu-24.04) RID="linux-x64" ;;
            macos-14)  RID="osx-x64" ;;
            windows-2022) RID="win-x64" ;;
          esac
          
          # Create runtime-specific directory
          mkdir -p "artifacts/runtimes/$RID/native"
          
          # Copy native libraries to the correct runtime folder
          if [[ "${{ matrix.os }}" == "windows-2022" ]]; then
            find build -name "*.dll" -type f -exec cp {} "artifacts/runtimes/$RID/native/" \; 2>/dev/null || true
            find build -name "*.lib" -type f -exec cp {} "artifacts/runtimes/$RID/native/" \; 2>/dev/null || true
          elif [[ "${{ matrix.os }}" == "ubuntu-24.04" ]]; then
            find build -name "*.so*" -type f -exec cp {} "artifacts/runtimes/$RID/native/" \; 2>/dev/null || true
            find build -name "*.a" -type f -exec cp {} "artifacts/runtimes/$RID/native/" \; 2>/dev/null || true
          elif [[ "${{ matrix.os }}" == "macos-14" ]]; then
            find build -name "*.dylib" -type f -exec cp {} "artifacts/runtimes/$RID/native/" \; 2>/dev/null || true
            find build -name "*.a" -type f -exec cp {} "artifacts/runtimes/$RID/native/" \; 2>/dev/null || true
          fi
          
          echo "Artifacts collected for $RID:"
          ls -la "artifacts/runtimes/$RID/native/" || echo "No native libraries found"
        shell: bash

      - name: Upload native libraries
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.os }}
          path: artifacts/runtimes/

  build-nuget:
    needs: build-native
    runs-on: ubuntu-24.04  # Use Linux for building the NuGet package
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Download all native libraries
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: native-libs

      - name: Organize native libraries for NuGet
        run: |
          # Create the runtimes directory structure
          mkdir -p bin/Release/runtimes
          
          # Copy all runtime folders from different OS builds
          echo "Downloaded artifacts structure:"
          find native-libs -type f -name "*" | head -20
          
          # Move native libraries to the correct location
          # Support both layouts:
          #   A) native-<os>/runtimes/<rid>/native/*
          #   B) native-<os>/<rid>/native/*
          for os_dir in native-libs/native-*; do
            # Determine source root
            if [ -d "$os_dir/runtimes" ]; then
              src_root="$os_dir/runtimes"
            else
              src_root="$os_dir"
            fi

            # Copy known RIDs if present
            for rid in linux-x64 osx-x64 win-x64; do
              if [ -d "$src_root/$rid/native" ]; then
                mkdir -p "bin/Release/runtimes/$rid/native"
                # Copy native libs preserving filenames
                cp -r "$src_root/$rid/native/"* "bin/Release/runtimes/$rid/native/" 2>/dev/null || true
                echo "Copied native libraries for $rid from $src_root"
              fi
            done
          done
          
          # Verify the structure
          echo "Final runtimes structure:"
          find bin/Release/runtimes -type f | sort
          
          # Check that we have libraries for all platforms
          for rid in linux-x64 osx-x64 win-x64; do
            if [ -d "bin/Release/runtimes/$rid/native" ]; then
              echo "‚úÖ Found native libraries for $rid"
              ls -la "bin/Release/runtimes/$rid/native/"
            else
              echo "‚ö†Ô∏è Missing native libraries for $rid"
            fi
          done
        shell: bash

      - name: Build .NET project
        run: |
          dotnet restore dotnet/MachineId.csproj
          dotnet build dotnet/MachineId.csproj --configuration Release --no-restore

      - name: Pack NuGet package
        run: |
          # Extract version from tag if it exists
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION=$(echo "${{ github.ref }}" | sed 's|refs/tags/v||')
            echo "Building version $VERSION from tag"
          else
            # Use a pre-release version for non-tagged builds
            COMMIT_SHORT=$(git rev-parse --short HEAD)
            VERSION="1.0.0-dev.$COMMIT_SHORT"
            echo "Building development version $VERSION"
          fi
          
          # Pack the NuGet package with all native libraries
          dotnet pack dotnet/MachineId.csproj \
            --configuration Release \
            --no-build \
            -p:Version=$VERSION \
            -p:PackageId="Dhhieu113.MachineId" \
            --output nupkgs
          
          # Verify the package contents
          echo "NuGet package created:"
          ls -la nupkgs/
          
          # Extract and inspect the package structure
          mkdir -p package-inspection
          unzip -l nupkgs/*.nupkg | head -50
        shell: bash

      - name: Upload NuGet package
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: nupkgs/*.nupkg

  test-nuget:
    needs: build-nuget
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04, macos-14, windows-2022]
    steps:
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: test-package

      - name: Test NuGet package installation
        run: |
          # Create a test project
          mkdir test-project
          cd test-project
          dotnet new console
          
          # Add the local package source
          dotnet nuget add source ../test-package --name local-test
          
          # Get the package name
          PACKAGE_FILE=$(ls ../test-package/*.nupkg | head -1)
          PACKAGE_NAME=$(basename "$PACKAGE_FILE" .nupkg | sed 's/\.[0-9].*//')
          
          echo "Installing package: $PACKAGE_NAME from $PACKAGE_FILE"
          
          # Install the package
          dotnet add package "$PACKAGE_NAME" --source ../test-package
          
          # Build the test project to ensure package works
          dotnet build
          
          echo "‚úÖ Package successfully installed and project builds on ${{ matrix.os }}"
        shell: bash

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-native, test-nuget]
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Download all native libraries
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: native-artifacts
          
      - name: Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: nuget-artifacts
          
      - name: Prepare release artifacts
        run: |
          mkdir -p release-artifacts
          
          # Create platform-specific archives for native libraries
          for os_dir in native-artifacts/native-*; do
            os_name=$(basename "$os_dir" | sed 's/native-//')
            
            case "$os_name" in
              ubuntu-24.04) 
                platform="linux-x64"
                ext="tar.gz"
                ;;
              macos-14)  
                platform="osx-x64"
                ext="tar.gz"
                ;;
              windows-2022) 
                platform="win-x64"
                ext="zip"
                ;;
            esac
            
            if [ -d "$os_dir/runtimes" ]; then
              echo "Creating archive for $platform"
              if [[ "$ext" == "tar.gz" ]]; then
                tar -czf "release-artifacts/machineid-native-$platform.$ext" -C "$os_dir/runtimes/$platform" native/
              else
                (cd "$os_dir/runtimes/$platform" && zip -r "../../../release-artifacts/machineid-native-$platform.$ext" native/)
              fi
            fi
          done
          
          # Copy NuGet package
          cp nuget-artifacts/*.nupkg release-artifacts/
          
          echo "Release artifacts:"
          ls -la release-artifacts/
        shell: bash
  
      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "release-artifacts/*"
          allowUpdates: true
          replacesArtifacts: true
          generateReleaseNotes: true
          body: |
            ## üì¶ Installation
            
            ### NuGet Package
            ```bash
            dotnet add package Dhhieu113.MachineId
            ```
            
            ### Native Libraries
            Platform-specific native libraries are available as separate downloads if needed.
            
            ## üéØ Supported Platforms
            - Windows (x64)
            - Linux (x64)
            - macOS (x64)
        env:
          GITHUB_TOKEN: ${{ github.token }}

  publish-nuget:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [test-nuget, release]
    runs-on: ubuntu-24.04
    steps:
      - name: Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: nupkgs
          
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'
      
      - name: Publish to NuGet.org
        run: |
          # List available packages
          echo "Publishing packages:"
          ls -la nupkgs/
          
          # Publish each package (should be just one)
          for package in nupkgs/*.nupkg; do
            echo "Publishing $(basename $package)..."
            dotnet nuget push "$package" \
              --api-key "$NUGET_API_KEY" \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate
          done
        shell: bash
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
